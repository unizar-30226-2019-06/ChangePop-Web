<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
   <!-- <link rel="icon" href="../../favicon.ico">-->

    <title>Jumbotron Template for Bootstrap</title>

    <!-- Bootstrap core CSS -->
    <link href="../static/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="../static/assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../static/style.css" rel="stylesheet">
    <script type="text/javascript" src="httpGet.js"></script> 
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="../static/assets/js/ie-emulation-modes-warning.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<script>
  var usuarioLog = JSON.parse(sessionStorage.getItem('usuarioLogeado'));
  var trades = JSON.parse(sessionStorage.getItem('trades'));
  var id = getParameterByName('idMensaje');
  if(!id){
    
  }
 // var urlObtenerMensajes = "http://kelpa-api.herokuapp.com/msgs/" + id;
 //Necesario para parsear el json
 // var jsonMensajes = JSON.parse(httpGet(urlObtenerMensajes));
//var jsonMensajes = JSON.parse('{"length": 5,"list": [{"body": "Hey hola me interesas.","date": "2019-05-27 00:46:50.782675+00:00","nick": "pepe"},{"body": "No el producto,sino tu .Tu me interesas BAKA","date": "2019-05-27 00:46:50.766942+00:00","nick": "pepe"},{"body": "Con que ignorandome eh??.Report ðŸ™‚ ","date": "2019-05-27 00:46:50.782675+00:00","nick": "pepe"},{"body": "LOL dat flamer","date": "2019-05-27 00:46:50.766942+00:00","nick": "Aa"},{"body": "Report tu tambien","date": "2019-05-27 00:46:50.766942+00:00","nick": "Aa"}]}');
    // var nick = usuarioLog.nick;
            // var mensajes = jsonMensajes.list;
//var trades = JSON.parse('{"length": 2,"list": [{"buyer_id": 81,"closed": false,"id": 342,"last_edit": "2019-05-27 00:46:50.761494+00:00","price": 5000,"product_id": 2509,"product_title": "Prueba usuario Aa Anuci","seller_id": 725},{"buyer_id": 725,"closed": false,"id": 343,"last_edit": "2019-05-27 00:46:50.761494+00:00","price": 5000,"product_id": 2510,"product_title": "Prueba usuario Aa Anuci","seller_id": 81, "products_offer" : [1672]}]}');

             </script>

  </head>

  <body>
    <!-- Barra de menu superior -->
    <nav class="navbar navbar-inverse navbar-fixed-top" style="display: none" id="no_reg_var">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#"><img src="../static/logo.jpg" width="55px" /></a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <form  method="get" class="navbar-form navbar-left" action="busquedaTexto.html">
            <div class="form-group">
              <input name="texto" type="text" class="form-control" placeholder="Buscar">
            </div>
            <button type="submit" class="btn btn-default"><i class="glyphicon glyphicon-search"></i></button>
          </form>


          <ul class="nav navbar-nav navbar-right">
            <li><a href="#Login" data-toggle="modal" role="button"><span
                  class="glyphicon glyphicon-log-in"></span>Conectarse</a></li>

            <li><a href="#Registro" data-toggle="modal" role="button"><span 
                class="glyphicon glyphicon-user"></span>Registrarse</a></li>
          </ul>

          <!-- Modal / Ventana / Overlay en HTML -->

        </div>
      </div>
    </nav>

    <nav class="navbar navbar-inverse navbar-fixed-top" style="display: none" id="reg_var">
        <div class="container">
          
          <div class="collapse navbar-collapse" id="myNavbar">
              <div class="navbar-header">
                  <a class="navbar-brand" href="index.html"><img  src="/static/logo.jpg" width="55px" /></a>
                </div>
                <form method="get" class="navbar-form navbar-left" action="busquedaTexto.html">
                   <form  method="get" class="navbar-form navbar-left" action="busquedaTexto.html">
            <div class="form-group">
              <input name="texto" type="text" class="form-control" placeholder="Buscar">
            </div>
            <button type="submit" class="btn btn-default"><i class="glyphicon glyphicon-search"></i></button>
          </form>
                  <form class="navbar-form navbar-left" method="get" action="crearAnuncio.html">
                        <button type="submit" class="btn btn-success">Subir producto</button>
                    </form>
            <ul class="nav navbar-nav navbar-right" id="in_line" >
                
                    <div class="dropdown"> 
                            <a data-toggle="dropdown" style="color:rgb(0, 0, 0);" >
                                <span style="color:white;font-weight:bold" id="nom" >Pedrito</span>
                            <img id="icono"  class='img-circle' height="42" width="42"  > </img>
                                <ul class="dropdown-menu">
                                    <li><a href="chat.html">Mensajes <span class="glyphicon glyphicon-envelope"></span> <span class="badge">10</span></li>
                                   <li><a href="miCarrito.html">Mi carrito  <span class="glyphicon glyphicon-shopping-cart my-cart-icon"></span> <span class="badge">10</span></li>
                                   <li><a  id='usuario' href="perfil_vendedor.html">Mi perfil <span class="glyphicon glyphicon-user"></span></a></li>
                                 <li><a href="editarUsuario.html">Editar perfil <span class="glyphicon glyphicon-cog"></span></a></li>
                                  <li><a href="index.html" onclick="logout()">Desconectarse <span class="glyphicon glyphicon-off"></span></a></li>
                                  <script>
                                    function logout(){
                                      sessionStorage.removeItem("usuarioLogeado");
                                      var usrLogOut = "http://kelpa-api.herokuapp.com/logout";
                                          getCORS(urlUserLog,function(data){ });
                                    }
                                  </script>
                                  
                               </ul>
                        </div>
                    </a>
                    
                
                    </div>
                    
            </ul>
          </div>
        </div>
    </nav>


    <div class="container">
    	<div class="row" style="margin-top:10px; margin-bottom:40px">

            <div class="col-xs-4" style="overflow-y:auto; max-height:600px;">

      <script>
        
          //Obtener intercambios
          var productosUsuarios = JSON.parse(httpGet('http://kelpa-api.herokuapp.com/products/' + usuarioLog.id)).list;

          for (i in trades.list) {
            var estado = "Z";
            if(trades.list[i].buyer_id == usuarioLog.id){
              estado = "Venta";
            }
            else{
              estado = "Comprad";
            }

                /*var buyer = 'http://kelpa-api.herokuapp.com/user/' + trades.list[i].buyer_id;
            var jsonBuyer = JSON.parse(httpGet(buyer));
            nickBuyer = jsonBuyer.nick;

                var seller = 'http://kelpa-api.herokuapp.com/user/' + trades.list[i].seller_id;
            var jsonSeller = JSON.parse(httpGet(seller));
            nickSeller = jsonSeller.nick;*/
              //Titulo conectado a los mensajes
            document.write('<div class="row">');
            document.write('<div class="row"> <a onclick="crearChatString('+ trades.list[i].id  +')"><label class="col-xs-12 control-label"style="vertical-align: middle;font-size: 2em;">' + trades.list[i].product_title + '</label></a></div> ');
           //precio,venta o compra venndedor id?
           
            document.write('<div class="row"><a href="#verConversation">');
            document.write('<div class="col-lg-offset-2 col-lg-10"> <em>' + estado + '</em> </div>');
            document.write('<div class="col-lg-offset-2 col-lg-10"><em>Precio : <span id="p-' + i + '">' + trades.list[i].price + '</span>â‚¬</em> </div>');
            document.write('<div class="col-lg-offset-2 col-lg-10"> <em>Vendedor ' + trades.list[i].buyer_id + ' con ' + trades.list[i].seller_id + '</em> </div>')
          
            document.write('</div></a></div>');

           //Productos ofrecidos

            document.write('<div ><button class="btn btn-primary " onclick=oferta(' + trades.list[i].id   + ') type="button"">Oferta actual'
               + '</button>');
                  
            /*for(po in trades.list[i].products_offer){
              var producto = JSON.parse(httpGet ('http://kelpa-api.herokuapp.com/product/' + trades.list[i].products_offer[po])  );
              document.write(' <li><a href=anuncio.html?idAnuncio"' + producto.id + '">'+ producto.title +'</a></li>')
              //document.write('<div class="row"><div class="col-lg-offset-2 col-lg-10"> + Productos que ofrece : <span id="p-actual-' + i + '">' + product_offer.title + '</span></div></div>');
            }*/
            document.write(" </ul> </div>")
            //Proponer productos
            if(trades.list[i].buyer_id == usuarioLog.id){
              document.write('<p><br /><select name="intercambio" id="i-' + i + '">');

              for(p in productosUsuarios){
                document.write('<option value="' + productosUsuarios[p].id + '">' + productosUsuarios[p].title + '</option>');
              }
              document.write('</select><button type="submit" onclick="proponerProducto(' + i + ', ' + trades.list[i].id + ');" class="btn btn-default">Ofrecer</button></p> ');
            }
            
              
            else{
              document.write('<button type="submit" onclick="borrar(' + trades.list[i].id + ');" class="btn btn-default">Borrar</button>');
            }
              document.write('<button type="submit" onclick="aceptar(' + trades.list[i].id + ');" class="btn btn-default">Confirmar/Desconfirmar</button>');
              document.write('<hr>');
        }
    
	function proponerProducto(i, id)
	{
		
		
		var precio = document.getElementById("p-" + i).value; 
		var intercambio = document.getElementById("i-" + i).value; 
       		var xhttp = new XMLHttpRequest();
          	xhttp.open("PUT", "https://kelpa-api.herokuapp.com/trade/" + intercambio + "/offer", true);
		params = 'price=' + precio + '&products=' + [intercambio];
		xhttp.send(params);
                put("http://kelpa-api.herokuapp.com/trade/" + id,null,function(){
                  alert("Usuario modificado correctamente");

		//Ã€ CONTINUER ICI
		 var trade = 'http://kelpa-api.herokuapp.com/trade/' + id;
             var trades = JSON.parse(httpGet(trade));
		  document.getElementById("p-actual-" + i).value = document.getElementById("p-actual-" + i).value  + trades.title; 
	
                }, function(){
                  alert("No se pudo modificar el usuario");
                });
	}
	function aceptar(id)
	{
                put("http://kelpa-api.herokuapp.com/trade/" + id + "/confirm",null,function(){
                  alert("Aceptacion hecha correctamente");
                }, function(){
                  alert("No se pudo aceptar");
                });
		location.reload() ; 
	}
	function borrar(id)
	{
                put("http://kelpa-api.herokuapp.com/trade/" + id + "/delete",null,function(){
                  alert("Borrado correctamente");
                }, function(){
                  alert("No se pudo borrar");
                });
		location.reload() ; 
	}
      </script>

            </div>
            <div class="col-xs-8" style="border: none;  border-left: 1px solid #151;">
                <div class="row" style="overflow-y:auto; max-height:550px;overflow-x: hidden;">
		    <div class="row" style="margin-left:10%;">
		        <a  href="perfil_vendedor.php"><img  id='anuncioImagen' class="col-xs-4 img-circle" src="icono.jpg" style="width: 8%; vertical-align: middle;">
		        <label id='tituloAnuncio' class="col-xs-4 control-label"style="vertical-align: middle;font-size: 2em;">Prueba usuario Aa Anuci</label></a>  <!-- nombre del vendedor -->
        </div>
        
        <div id='chat'> gelo</div>
			<script>/*
			    for (i in mensajes) {
					document.write('<div class="container_chat');
					//if(mensajes[i].nick == usuarioLog.nick)
					if(mensajes[i].nick == nick)
					{
						document.write(' darker" style="margin-left:20%;">');
					}
					else
					{
						document.write('">');
					}
					document.write('<p class="text-left"></p>' + mensajes[i].nick + ' - <em>' + mensajes[i].body + '</em><br/><span class="time-left">' + mensajes[i].date.slice(0,-16) + '</span></div>');
        }
        */
			</script>

                </div>
			<hr>
			<script>
			
			</script>
			 
		        <div class="input-append">
		            <input id="msg" type="text" class="span2 search-query top bottom"style="width: 40%; margin-left: 25%; margin-top: 20px">
		            <button id='enviarBoton' disabled='true' class="btn btn-info">Enviar</button>
		        </div>
		    
<br /><br /><br />
        </div>
    </div>
    <script>

      //Mostrar oferta
       function oferta(id){
        url = "https://kelpa-api.herokuapp.com/trade/" + id;
        getQuery(url,function (data){
          var oferta = "Precio ofrecido:" + data.precio +"\n Productos:";
          
            var productsID =  data.products_offer.toString();
            productsID = productsID.replace('(','' );
            productsID = productsID.replace(')','' );
            var products = productsID.split(',');
            console.log(productsID);
            for(i in products){
            var producto = JSON.parse(httpGet ('http://kelpa-api.herokuapp.com/product/' + products[i] ) );
              oferta += producto.title +"\n";    
            }
           alert(oferta);
       });
      } 
      //CHAT
      function crearChatString(idTrade){
        getQuery("https://kelpa-api.herokuapp.com/msgs/"+idTrade,function(data){
          var mensajes = data.list;
          var result = "";
        for (i in mensajes) {
          
					result += '<div class="container_chat';
					//if(mensajes[i].nick == usuarioLog.nick)
					if(mensajes[i].nick == usuarioLog.nick){
						result += ' darker" style="margin-left:20%;">' ;
					}
					else
					{
					  result +='">';
					}
        result += '<p class="text-left"></p>' + mensajes[i].nick   + ' - <em>' + mensajes[i].body + '</em><br/><span class="time-left">' + mensajes[i].date + '</span></div>';
        
        }
        document.getElementById('chat').innerHTML = result; 
        document.getElementById('enviarBoton').disabled = false;
        document.getElementById('enviarBoton').onclick = enviar(idTrade);
        });
        
        
      }

      function enviar(idTrade){
        var params = {
          body : document.getElementById("msg").value
        };
         var url = "https://kelpa-api.herokuapp.com/msgs/" + idTrade;
        postCookies(url,params,function(){
          crearChatString(idTrade);
        },
         function(){
            console.log("No se pudo enviar");
        }); 
				
			}


      //NAVBAR
      if(sessionStorage.getItem('usuarioLogeado') == null){
        document.getElementById("no_reg_var").style.display='block';
        document.getElementById("reg_var").style.display='none';
      }else{
        var usuarioLog = JSON.parse(sessionStorage.getItem('usuarioLogeado'));
        document.getElementById("icono").src = usuarioLog.avatar ;
        document.getElementById("nom").innerHTML = usuarioLog.nick ;
        document.getElementById("usuario").href =  "perfil_vendedor.html?nick=" + usuarioLog.nick ;
        document.getElementById("reg_var").style.display='block';
        document.getElementById("no_reg_var").style.display='none';
      }
      
    </script>

     <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    
    <script>window.jQuery || document.write('<script src="assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="../static/dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../static/assets/js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
